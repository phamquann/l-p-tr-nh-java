<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="vi">
<head th:replace="~{admin/fragments::admin-head}"></head>
<body>
    <div class="container-fluid p-0">
        <div class="row g-0">
            <nav th:replace="~{admin/fragments::sidebar('reports')}"></nav>
            <main class="main-content">
                <div th:replace="~{admin/fragments::topbar('üìä Th·ªëng k√™ & B√°o c√°o', 'Ph√¢n t√≠ch d·ªØ li·ªáu kinh doanh')}"></div>
                <div class="px-4"><th:block th:replace="~{fragments/flash-messages::flash-messages}"></th:block></div>
                <div class="container-fluid px-4">
                    
                    <!-- Th·ªëng k√™ t·ªïng quan -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-0">üìö T·ªïng s√°ch</h6>
                                            <h2 class="mb-0" th:text="${overallStats?.totalBooks ?: 0}">0</h2>
                                        </div>
                                        <div style="font-size: 3rem; opacity: 0.5;">üìö</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-0">üí∞ T·ªïng doanh thu</h6>
                                            <h2 class="mb-0" th:text="${overallStats?.totalRevenue != null ? (#numbers.formatDecimal(overallStats.totalRevenue, 0, 'COMMA', 0, 'POINT') + '‚Ç´') : '0‚Ç´'}">0‚Ç´</h2>
                                        </div>
                                        <div style="font-size: 3rem; opacity: 0.5;">üí∞</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-0">üì¶ T·ªïng ƒë∆°n h√†ng</h6>
                                            <h2 class="mb-0" th:text="${overallStats?.totalInvoices ?: 0}">0</h2>
                                        </div>
                                        <div style="font-size: 3rem; opacity: 0.5;">üì¶</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-dark">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-0">üë• Ng∆∞·ªùi d√πng</h6>
                                            <h2 class="mb-0" th:text="${overallStats?.totalUsers ?: 0}">0</h2>
                                        </div>
                                        <div style="font-size: 3rem; opacity: 0.5;">üë•</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Row ch√≠nh: Top s√°ch + Th·ªëng k√™ danh m·ª•c -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">üèÜ Top 5 s√°ch b√°n ch·∫°y nh·∫•t</h5>
                                </div>
                                <div class="card-body">
                                    <div th:if="${topBooks != null && !topBooks.isEmpty()}">
                                        <div th:each="book, iterStat : ${topBooks}" class="d-flex align-items-center mb-3 p-3 rounded" 
                                             th:classappend="${iterStat.index == 0 ? 'bg-warning bg-opacity-25' : 'bg-light'}">
                                            <div class="badge me-3 d-flex align-items-center justify-content-center" 
                                                 style="width: 35px; height: 35px; border-radius: 50%; font-size: 1.1rem;" 
                                                 th:classappend="${iterStat.index == 0 ? 'bg-warning text-dark' : (iterStat.index == 1 ? 'bg-secondary' : 'bg-dark')}" 
                                                 th:text="${iterStat.index + 1}">1</div>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1 fw-bold" th:text="${book.bookTitle}">T√™n s√°ch</h6>
                                                <small class="text-muted">
                                                    <i class="bi bi-person"></i> <span th:text="${book.bookAuthor}">T√°c gi·∫£</span> | 
                                                    <i class="bi bi-tag"></i> <span th:text="${book.categoryName}">Danh m·ª•c</span>
                                                </small>
                                                <div class="mt-2 d-flex gap-2">
                                                    <span class="badge bg-success">
                                                        <i class="bi bi-cart-check"></i> <span th:text="${book.totalSold}">0</span> ƒë√£ b√°n
                                                    </span>
                                                    <span class="badge bg-info">
                                                        <i class="bi bi-currency-dollar"></i> 
                                                        <span th:text="${book.revenue != null ? (#numbers.formatDecimal(book.revenue, 0, 'COMMA', 0, 'POINT') + '‚Ç´') : '0‚Ç´'}">0‚Ç´</span>
                                                    </span>
                                                    <span class="badge bg-secondary">
                                                        <span th:text="${book.price != null ? (#numbers.formatDecimal(book.price, 0, 'COMMA', 0, 'POINT') + '‚Ç´/cu·ªën') : '0‚Ç´/cu·ªën'}">0‚Ç´/cu·ªën</span>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div th:if="${topBooks == null || topBooks.isEmpty()}" class="text-center py-5">
                                        <i class="bi bi-graph-down text-muted" style="font-size: 64px;"></i>
                                        <h5 class="text-muted mt-3">Ch∆∞a c√≥ d·ªØ li·ªáu b√°n h√†ng</h5>
                                        <p class="text-muted">C·∫ßn c√≥ ƒë∆°n h√†ng ho√†n th√†nh ƒë·ªÉ hi·ªÉn th·ªã th·ªëng k√™ b√°n h√†ng</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="mb-0">üìä Th·ªëng k√™ danh m·ª•c</h5>
                                </div>
                                <div class="card-body">
                                    <div th:if="${categoryStats != null && !categoryStats.isEmpty()}">
                                        <div th:each="category : ${categoryStats}" class="border-bottom pb-3 mb-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h6 class="mb-1" th:text="${category.categoryName}">Danh m·ª•c</h6>
                                                <span class="badge bg-primary" th:text="${category.bookCount} + ' s√°ch'">0 s√°ch</span>
                                            </div>
                                            <div class="d-flex justify-content-between small text-muted">
                                                <span>Doanh thu:</span>
                                                <span class="text-success fw-bold" 
                                                      th:text="${category.revenue != null ? (#numbers.formatDecimal(category.revenue, 0, 'COMMA', 0, 'POINT') + '‚Ç´') : '0‚Ç´'}">0‚Ç´</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div th:if="${categoryStats == null || categoryStats.isEmpty()}" class="text-center py-4">
                                        <i class="bi bi-pie-chart text-muted" style="font-size: 48px;"></i>
                                        <p class="text-muted mt-2">Ch∆∞a c√≥ danh m·ª•c</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Row th·ª© 2: Tr·∫°ng th√°i ƒë∆°n h√†ng + Th·ªëng k√™ 7 ng√†y -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">üìã Tr·∫°ng th√°i ƒë∆°n h√†ng</h5>
                                </div>
                                <div class="card-body">
                                    <div th:if="${orderStatusStats != null && orderStatusStats.totalOrders > 0}">
                                        <div class="text-center mb-3">
                                            <h3 class="text-primary mb-0" th:text="${orderStatusStats.totalOrders}">0</h3>
                                            <small class="text-muted">T·ªïng ƒë∆°n h√†ng</small>
                                        </div>
                                        <div th:with="statusCount=${orderStatusStats.statusCount}">
                                            <div class="row mb-2 align-items-center">
                                                <div class="col-7">
                                                    <span class="badge bg-warning me-2">‚óè</span>Ch·ªù x·ª≠ l√Ω
                                                </div>
                                                <div class="col-5 text-end">
                                                    <span class="fw-bold" th:text="${statusCount.PENDING ?: 0}">0</span>
                                                </div>
                                            </div>
                                            <div class="row mb-2 align-items-center">
                                                <div class="col-7">
                                                    <span class="badge bg-primary me-2">‚óè</span>ƒê√£ x√°c nh·∫≠n
                                                </div>
                                                <div class="col-5 text-end">
                                                    <span class="fw-bold" th:text="${statusCount.CONFIRMED ?: 0}">0</span>
                                                </div>
                                            </div>
                                            <div class="row mb-2 align-items-center">
                                                <div class="col-7">
                                                    <span class="badge bg-info me-2">‚óè</span>ƒêang giao h√†ng
                                                </div>
                                                <div class="col-5 text-end">
                                                    <span class="fw-bold" th:text="${statusCount.SHIPPING ?: 0}">0</span>
                                                </div>
                                            </div>
                                            <div class="row mb-2 align-items-center">
                                                <div class="col-7">
                                                    <span class="badge bg-success me-2">‚óè</span>Ho√†n th√†nh
                                                </div>
                                                <div class="col-5 text-end">
                                                    <span class="fw-bold text-success" th:text="${statusCount.COMPLETED ?: 0}">0</span>
                                                </div>
                                            </div>
                                            <div class="row align-items-center">
                                                <div class="col-7">
                                                    <span class="badge bg-danger me-2">‚óè</span>ƒê√£ h·ªßy
                                                </div>
                                                <div class="col-5 text-end">
                                                    <span class="fw-bold text-danger" th:text="${statusCount.CANCELLED ?: 0}">0</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div th:if="${orderStatusStats == null || orderStatusStats.totalOrders == 0}" class="text-center py-4">
                                        <i class="bi bi-clipboard-data text-muted" style="font-size: 48px;"></i>
                                        <p class="text-muted mt-2">Ch∆∞a c√≥ ƒë∆°n h√†ng</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">üìà Ho·∫°t ƒë·ªông 7 ng√†y qua</h5>
                                </div>
                                <div class="card-body">
                                    <div th:if="${last7DaysStats != null && !last7DaysStats.isEmpty()}">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-borderless">
                                                <thead>
                                                    <tr class="border-bottom">
                                                        <th>Ng√†y</th>
                                                        <th class="text-center">ƒê∆°n h√†ng</th>
                                                        <th class="text-end">Doanh thu</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr th:each="day : ${last7DaysStats}">
                                                        <td class="fw-bold" th:text="${day.date}">01/02</td>
                                                        <td class="text-center">
                                                            <span class="badge bg-info" th:text="${day.orders}">0</span>
                                                        </td>
                                                        <td class="text-end">
                                                            <span class="text-success fw-bold" th:text="${day.revenue != null && day.revenue > 0 ? (#numbers.formatDecimal(day.revenue, 0, 'COMMA', 0, 'POINT') + '‚Ç´') : '0‚Ç´'}">0‚Ç´</span>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <hr>
                                        <div class="text-center">
                                            <small class="text-muted">
                                                <i class="bi bi-info-circle"></i> Ch·ªâ t√≠nh doanh thu t·ª´ ƒë∆°n h√†ng ƒë√£ ho√†n th√†nh
                                            </small>
                                        </div>
                                    </div>
                                    <div th:if="${last7DaysStats == null || last7DaysStats.isEmpty()}" class="text-center py-4">
                                        <i class="bi bi-bar-chart text-muted" style="font-size: 48px;"></i>
                                        <p class="text-muted mt-2">Ch∆∞a c√≥ ho·∫°t ƒë·ªông</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card border-info">
                                <div class="card-header bg-info bg-opacity-10">
                                    <h5 class="mb-0 text-info">üí° H∆∞·ªõng d·∫´n</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="fw-bold">ƒê·ªÉ c√≥ d·ªØ li·ªáu th·ªëng k√™:</h6>
                                            <ul class="list-unstyled">
                                                <li><i class="bi bi-check-circle text-success"></i> Th√™m danh m·ª•c s√°ch t·∫°i <a href="/admin/categories" class="text-decoration-none">Qu·∫£n l√Ω danh m·ª•c</a></li>
                                                <li><i class="bi bi-check-circle text-success"></i> Th√™m s√°ch v√†o danh m·ª•c</li>
                                                <li><i class="bi bi-check-circle text-success"></i> Kh√°ch h√†ng ƒë·∫∑t h√†ng v√† thanh to√°n</li>
                                                <li><i class="bi bi-check-circle text-success"></i> C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng th√†nh "COMPLETED"</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="fw-bold">C√°c th·ªëng k√™ c√≥ s·∫µn:</h6>
                                            <ul class="list-unstyled">
                                                <li><i class="bi bi-graph-up text-primary"></i> Th·ªëng k√™ t·ªïng quan (s√°ch, doanh thu, ƒë∆°n h√†ng, user)</li>
                                                <li><i class="bi bi-trophy text-warning"></i> Top 5 s√°ch b√°n ch·∫°y nh·∫•t</li>
                                                <li><i class="bi bi-pie-chart text-info"></i> Doanh thu theo danh m·ª•c</li>
                                                <li><i class="bi bi-bar-chart text-success"></i> Ho·∫°t ƒë·ªông theo ng√†y (7 ng√†y g·∫ßn nh·∫•t)</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <script th:src="@{/js/bootstrap.min.js}"></script>
</body>
</html>